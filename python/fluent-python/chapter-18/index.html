<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Chapter 18 | Dongseok Kim</title> <meta name="author" content="Dongseok Kim"> <meta name="description" content="with, match, and else Blocks"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/atom-one-light.min.css" media="" id="highlight_theme_light"> <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/atom-one-dark.min.css" media="none" id="highlight_theme_dark"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://d0ngse0kkim.github.io/python/fluent-python/chapter-18/"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "Chapter 18",
      "description": "with, match, and else Blocks",
      "published": "February 3, 2024",
      "authors": [
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Dongseok </span>Kim</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">programming</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/python">Python</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/softwaredesign/">Software Design</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/tools/">Tools</a> </div> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">hobbies</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/running">running</a> </div> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">others</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/repositories">repositories</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/cv/">cv</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Chapter 18</h1> <p>with, match, and else Blocks</p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="#abstarct">Abstarct</a></div> <div><a href="#context-managers-and-with-blocks">Context Managers and with Blocks</a></div> <div><a href="#pattern-matching-in-lis-py-a-case-study">Pattern Matching in lis.py A Case Study</a></div> <div><a href="#do-this-then-that-else-blocks-beyond-if">Do This Then That else Blocks Beyond if</a></div> <div><a href="#chapter-summary">Chapter Summary</a></div> <div><a href="#links">Links</a></div> </nav> </d-contents> <h2 id="abstarct">Abstarct</h2> <p>This is a summary of the chapter 18 of the book “Fluent Python” by Luciano Ramalho.</p> <p>This chapter covers the following topics:</p> <ol> <li>The <code>with</code> statement and context managers</li> <li>The <code>match</code>/<code>case</code> statement for pattern matching</li> <li>The <code>else</code> block in <code>for</code>, <code>while</code>, and <code>try</code> statements</li> </ol> <h2 id="context-managers-and-with-blocks">Context Managers and with Blocks</h2> <p>The <code>with</code> statement was introduced in Python 2.5, and it is used to simplify the <code>try/finally</code> pattern <sup id="fnref:pythonorg__try_finally" role="doc-noteref"><a href="#fn:pythonorg__try_finally" class="footnote" rel="footnote">1</a></sup>.</p> <p>The <code>try/finally</code> pattern is used to ensure that some operation is performed after a block of code, even if the block is terminated by</p> <ol> <li> <code>return</code> statement,</li> <li>raising an exception, or</li> <li>a <code>sys.exit()</code> call.</li> </ol> <p>A code block that starts with <code>finally</code> clause usually performs cleanup actions such as releasing a critical resource or restoring some previous state that was temporarily changed.</p> <p>The <code>with</code> statement simplifies the <code>try/finally</code> pattern by encapsulating the cleanup logic in so-called <em>context managers</em>. There is some examples from the standard library:</p> <ol> <li>“How to use the connection context manager” in <code>sqlite3</code> module documents <sup id="fnref:pythonorg__sqlite3_context_manager" role="doc-noteref"><a href="#fn:pythonorg__sqlite3_context_manager" class="footnote" rel="footnote">2</a></sup> </li> <li>“Using locks, conditions, and semaphores in the with statement” in the <code>threading</code> module documents <sup id="fnref:pythonorg__threading_example_with" role="doc-noteref"><a href="#fn:pythonorg__threading_example_with" class="footnote" rel="footnote">3</a></sup> </li> <li>Usage of <code>decimal.localcontext()</code> for temporary changes to the precision and rounding rules for the <code>Decimal</code> class <sup id="fnref:pythonorg__decimal_example_with" role="doc-noteref"><a href="#fn:pythonorg__decimal_example_with" class="footnote" rel="footnote">4</a></sup> </li> <li>Patching objetc for testing with <code>unittest.mock.patch()</code> <sup id="fnref:pythonorg__unittestmock_example_with" role="doc-noteref"><a href="#fn:pythonorg__unittestmock_example_with" class="footnote" rel="footnote">5</a></sup> </li> </ol> <h3 id="the-context-manager-interface"><em>The context manager interface</em></h3> <p>The context manager interface consists of the following methods:</p> <dl> <dt><code>__enter__()</code></dt> <dd> </dd> </dl> <ul> <li>This method is called with no arguments when the execution flow enters the <code>with</code> block.</li> <li>return value: the object to be bound to the target variable in the <code>with</code> statement</li> </ul> <dl> <dt><code>__exit__(exc_type, exc_value, traceback)</code></dt> <dd> </dd> </dl> <ul> <li>This method is called when the execution flow exits the <code>with</code> block for any reason.</li> <li> <code>exc_type</code> : exception class (e.g. <code>ZeroDivisionError</code>)</li> <li> <code>exc_value</code> : exception instance (e.g. <code>ZeroDivisionError("integer division or modulo by zero")</code>)</li> <li> <code>traceback</code> : traceback object</li> <li>return value: <code>True</code> if the exception was handled, <code>False</code> or <code>None</code> if it was not handled</li> </ul> <h3 id="simple-example-of-a-context-manager"><em>Simple example of a context manager</em></h3> <pre><code class="language-python">&gt;&gt;&gt; with open('hello.txt', 'w') as fp:  # &lt;1&gt;
...     fp.write('hello world!')  # &lt;2&gt;
...
&gt;&gt;&gt; fp  # &lt;3&gt;
&lt;_io.TextIOWrapper name='hello.txt' mode='w' encoding='UTF-8'&gt;
&gt;&gt;&gt; fp.closed, fp.encoding  # &lt;4&gt;
(True, 'UTF-8')
&gt;&gt;&gt; fp.write('hello again!')  # &lt;5&gt;
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
ValueError: I/O operation on closed file.
</code></pre> <ul> <li> <code>&lt;1&gt;</code> : <code>open()</code> returns a <code>TextIOWrapper</code> object, and a return value from the <code>__enter__()</code> method of <code>TextIOWrapper</code> is bound to the variable <code>fp</code>. <ul> <li>The <code>TextIOWrapper</code> object is a context manager that implements the <code>__enter__()</code> and <code>__exit__()</code> methods.</li> </ul> </li> <li> <code>&lt;2&gt;</code> : <code>fp.write()</code> is called to write a string to the file.</li> <li> <code>&lt;3&gt;</code> : <code>fp</code> is still bound to the <code>TextIOWrapper</code> object. <ul> <li> <strong>Note</strong>: <code>with</code> block does not define a new scope.</li> </ul> </li> <li> <code>&lt;4&gt;</code> : <code>fp</code> is closed and the encoding is set to <code>'UTF-8'</code>. <ul> <li> <code>__exit__()</code> method of <code>TextIOWrapper</code> is called and <code>fp.closed</code> is set to <code>True</code> when the execution flow exits the <code>with</code> block.</li> </ul> </li> <li> <code>&lt;5&gt;</code> : <code>fp.write()</code> raises a <code>ValueError</code> because <code>fp</code> is closed.</li> </ul> <p>Important points are as follows:</p> <ol> <li>The context manager is a result of evaluating the expression after the <code>with</code> keyword.</li> <li>The context manager exists until the execution flow exits the <code>with</code> block and the <code>__exit__()</code> method of the context manager is called.</li> <li>The bounded variable is assigned the return value of the <code>__enter__()</code> method of the context manager.</li> <li> <code>with</code> block does not define a new scope. <ul> <li>The context manager object is bound to the variable in the <code>with</code> statement.</li> </ul> </li> </ol> <h3 id="example-of-a-context-manager-class"><em>Example of a context manager class</em></h3> <p>In this subsection, a class that implements the context manager interface is implemented. The following code demonstrates how to use the context manager class.</p> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="6527037ae7319ba370a1ee2d9fe79214d0ed9452" path="18-with-match/mirror.py" language="python" line="9-19"></div> <ul> <li> <code>&lt;1&gt;</code> : The context manager is an instance of the <code>LookingGlass</code> class. Python invokes the <code>__enter__()</code> method of the <code>LookingGlass</code> class and binds the return value of the <code>__enter__()</code> method to the variable <code>what</code>.</li> <li> <code>&lt;2&gt;</code> : The context manager monkey-patches the <code>sys.stdout.write</code> object. Therefore, the output of each <code>print()</code> will be reversed.</li> <li> <code>&lt;3&gt;</code>, <code>&lt;4&gt;</code> : The context manager is exited and the <code>__exit__()</code> method of the context manager object is called. <ul> <li>The <code>__exit__()</code> method restores the original <code>sys.stdout.write</code> object.</li> <li>The output of program is restored to normal.</li> </ul> </li> </ul> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="6527037ae7319ba370a1ee2d9fe79214d0ed9452" path="18-with-match/mirror.py" language="python" line="72-89"></div> <ul> <li> <code>&lt;1&gt;</code>, <code>&lt;4&gt;</code> : The <code>__enter__()</code> method with no arguments is called when the execution flow enters the <code>with</code> block. The return value <code>JABBERWOCKY</code> of the <code>__enter__()</code> method will be bound to the variable in the <code>with</code> clause.</li> <li> <code>&lt;2&gt;</code>, <code>&lt;3&gt;</code>, <code>&lt;5&gt;</code> : The <code>__enter__</code> method monkey-patches the <code>sys.stdout.write</code> method by the <code>self.reverse_write(text)</code> method. <ul> <li>The <code>self.reverse_write(text)</code> method reverses the text and calls the original <code>sys.stdout.write</code> method.</li> </ul> </li> <li> <code>&lt;6&gt;</code> : The <code>__exit__()</code> method is called when the execution flow exits the <code>with</code> block. <ul> <li>When the execution flow exits the <code>with</code> block without an exception, <code>exc_type</code>, <code>exc_value</code>, and <code>traceback</code> are <code>None</code>.</li> <li>If an exception is raised in the execution of the <code>with</code> block, <code>exc_type</code>, <code>exc_value</code>, and <code>traceback</code> are the exception class, exception instance, and traceback object, respectively.</li> </ul> </li> <li> <code>&lt;7&gt;</code> : The <code>__exit__()</code> method restores the original <code>sys.stdout.write</code> method.</li> <li> <code>&lt;8&gt;</code>, <code>&lt;9&gt;</code> : When the execution flow exits the <code>with</code> block with a <code>ZeroDivisionError</code> exception, the <code>__exit__()</code> method prints an error message and returns <code>True</code> to indicate that the exception was handled.</li> <li> <code>&lt;10&gt;</code> : If the <code>__exit__()</code> method returns <code>False</code> or <code>None</code>, the exception is re-raised after the <code>__exit__()</code> method returns.</li> </ul> <p>In the following example, <code>ZeroDivisionError</code> is raised in the <code>with</code> block. Because <code>True</code> is returned from the <code>__exit__()</code> method, the exception is not delegated to the caller.</p> <pre><code class="language-python">&gt;&gt;&gt; with LookingGlass() as what:
...     print("abcd")
...     print(1/0)
...
dcba
Please DO NOT divide by zero!
</code></pre> <p>For a detailed explanation of the <code>__enter__()</code> and <code>__exit__()</code> methods, see the following codes which does the same thing as the <code>with</code> statement.</p> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="6527037ae7319ba370a1ee2d9fe79214d0ed9452" path="18-with-match/mirror.py" language="python" line="28-41"></div> <ul> <li> <code>&lt;1&gt;</code> : The variable <code>manager</code> holds the context manager object returned by the <code>LookingGlass()</code> constructor.</li> <li> <code>&lt;2&gt;</code> : The <code>__enter__()</code> method of the context manager object is called and the return value <code>JABBERWOCKY</code> is bound to the variable <code>monster</code>.</li> <li> <code>&lt;4&gt;</code> : Call <code>manager.__exit__(None, None, None)</code> to restore the original <code>sys.stdout.write</code> method.</li> </ul> <h3 id="parenthesized-context-managers-in-python-310"><em>Parenthesized context managers in Python 3.10</em></h3> <p>In Python 3.10<sup id="fnref:pythonorg__contextlib_parenthesized_context_managers" role="doc-noteref"><a href="#fn:pythonorg__contextlib_parenthesized_context_managers" class="footnote" rel="footnote">6</a></sup>, the <code>with</code> statement allows multiple context managers to be specified in a single statement. The following code is an example of using multiple context managers in a single <code>with</code> statement.</p> <pre><code class="language-python">with (
    CtxManager1() as var1,
    CtxManager2() as var2,
    CtxManager3() as var3,
):
    # do something
</code></pre> <h3 id="the-contextlib-utilities">The contextlib Utilities</h3> <p>There are some utilities in the <code>contextlib</code> module <sup id="fnref:pythonorg__contextlib" role="doc-noteref"><a href="#fn:pythonorg__contextlib" class="footnote" rel="footnote">7</a></sup> that help to create context managers.</p> <h4 id="functions-for-creating-context-managers"><em>Functions for creating context managers</em></h4> <dl> <dt> <code>contextlib.closing(thing)</code> <sup id="fnref:pythonorg__contextlib_closing" role="doc-noteref"><a href="#fn:pythonorg__contextlib_closing" class="footnote" rel="footnote">8</a></sup> </dt> <dd>This utility creates a context manager that closes the argument object using the <code>thing.close()</code> method.</dd> <dt> <code>contextlib.suppress(*exceptions)</code> <sup id="fnref:pythonorg__contextlib_suppress" role="doc-noteref"><a href="#fn:pythonorg__contextlib_suppress" class="footnote" rel="footnote">9</a></sup> </dt> <dd>This utility creates a context manager that suppresses the specified exceptions temporarily.</dd> <dt> <code>contextlib.nullcontext(enter_result=None)</code> <sup id="fnref:pythonorg__contextlib_nullcontext" role="doc-noteref"><a href="#fn:pythonorg__contextlib_nullcontext" class="footnote" rel="footnote">10</a></sup> </dt> <dd>This utility creates a context manager that returns the <code>enter_result</code> when the <code>__enter__()</code> method is called and does nothing when the <code>__exit__()</code> method is called.</dd> </dl> <h4 id="decorators-abc-for-creating-context-managers"><em>Decorators, ABC for creating context managers</em></h4> <dl> <dt> <code>@contextlib.contextmanager</code> <sup id="fnref:pythonorg__contextlib_contextmanager" role="doc-noteref"><a href="#fn:pythonorg__contextlib_contextmanager" class="footnote" rel="footnote">11</a></sup> </dt> <dd>This decorator converts a generator function into a context manager. The usage of this decorator will be explained in the next subsection.</dd> <dt> <code>class contextlib.AbstractContextManager</code> <sup id="fnref:pythonorg__contextlib_abstractcontextmanager" role="doc-noteref"><a href="#fn:pythonorg__contextlib_abstractcontextmanager" class="footnote" rel="footnote">12</a></sup> </dt> <dd>An abstract base class for creating a class for context managers. The following methods are provided by this class: <ul> <li> <code>__enter__()</code> : This method is a concrete method which returns <code>self</code> by default. It is possible to override this method to return a different object.</li> <li> <code>__exit__()</code> : This method is an abstract method which raises <code>NotImplementedError</code> by default. It is necessary to override this method to implement a context manager.</li> </ul> </dd> <dt> <code>class contextlib.ContextDecorator</code> <sup id="fnref:pythonorg__contextlib_contextdecorator" role="doc-noteref"><a href="#fn:pythonorg__contextlib_contextdecorator" class="footnote" rel="footnote">13</a></sup> </dt> <dd>A base class that enables a context manager to also be used as a decorator.</dd> <dt> <code>class contextlib.ExitStack</code> <sup id="fnref:pythonorg__contextlib_exitstack" role="doc-noteref"><a href="#fn:pythonorg__contextlib_exitstack" class="footnote" rel="footnote">14</a></sup> </dt> <dd>This class is a context manager that can be used to combine multiple context managers. The <code>ExitStack</code> class is useful when the number of context managers is not known in advance. For example, the <code>ExitStack</code> class can be used to close multiple files.</dd> </dl> <p>To use the <code>ExitStack</code> class, instantiate the <code>ExitStack</code> class and use the object of <code>ExitStack</code> class as a context manager with <code>with</code> clause. The return value of <code>__enter__()</code> method of the <code>ExitStack</code> object has the <code>enter_context()</code> method. This method is used to add a context manager to the <code>ExitStack</code> object. The <code>enter_context()</code> method returns the context manager object that is added to the <code>ExitStack</code> object.</p> <p>When the execution flow exits the <code>with</code> block, the <code>__exit__()</code> method of each context manager is called in the reverse order of the <code>__enter__()</code> method calls.</p> <pre><code class="language-python">with ExitStack() as stack:
    files = [stack.enter_context(open(fname)) for fname in filenames]
    # All opened files will automatically be closed at the end of
    # the with statement, even if attempts to open files later
    # in the list raise an exception
</code></pre> <h3 id="using-contextmanager">Using @contextmanager</h3> <p>The <code>@contextmanager</code> decorator is used to convert a generator function into a context manager. By using this decorator, it is possible to create a context manager without defining a class that implements the context manager interface.</p> <p>In a generator decorated with <code>@contextmanager</code>, <code>yield</code> is used to split the body of the function into two parts:</p> <ul> <li>The code before the <code>yield</code> statement is executed in the <code>__enter__()</code> method of the context manager.</li> <li>The code after the <code>yield</code> statement is executed in the <code>__exit__()</code> method of the context manager.</li> <li>The yielded value is bound to the variable in the <code>with</code> statement.</li> </ul> <p>The following code is an example of using the <code>@contextmanager</code> decorator.</p> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="2f2f87d4fb297869cb5763ec9b2ffcad3e841d20" path="18-with-match/mirror_gen.py" language="python" line="66-78"></div> <ul> <li> <code>&lt;1&gt;</code> : The <code>@contextlib.contextmanager</code> decorator convert the <code>looking_glass()</code> generator function into a context manager.</li> <li> <code>&lt;2&gt;</code> : <code>original_write</code> holds the original <code>sys.stdout.write</code> method.</li> <li> <code>&lt;3&gt;</code> : Defines the reversed version of <code>sys.stdout.write</code> method as a <code>reverse_write()</code> function.</li> <li> <code>&lt;4&gt;</code> : Monkey-patches the <code>sys.stdout.write</code> method into the <code>reverse_write()</code> function.</li> <li> <code>&lt;5&gt;</code> : The yielded value is bound to the variable in the <code>with</code> statement.</li> <li> <code>&lt;6&gt;</code> : Restores the original <code>sys.stdout.write</code> method.</li> </ul> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="2f2f87d4fb297869cb5763ec9b2ffcad3e841d20" path="18-with-match/mirror_gen.py" language="python" line="9-19"></div> <ul> <li> <code>&lt;1&gt;</code> : Invoking the <code>looking_glass()</code> function returns a context manager object. By applying the <code>with</code> statement to the context manager object, the <code>__enter__()</code> method of the context manager object is called and the return value <code>JABBERWOCKY</code> is bound to the variable <code>what</code>.</li> </ul> <p>If an exception is raised in the body of the block started by the <code>with</code> statement, the execution flow is executed the following steps:</p> <ol> <li>The Python interpreter catches the exception when the exception is raised.</li> <li>The execution flow is transferred into the <code>yield</code> statement in the <code>looking_glass()</code>, and the Python interpreter raises the exception again.</li> <li>After the exception is raised, the <code>looking_glass()</code> generator is terminated and the remaining code after the <code>yield</code> statement in the <code>looking_glass()</code> is not executed.</li> </ol> <p>The following code is an example that raises an exception in the body of the block started by the <code>with</code> statement.</p> <pre><code class="language-python">&gt;&gt;&gt; with looking_glass() as what:
...      print('Alice, Kitty and Snowdrop')
...      print(f'{1/0}')  # &lt;1&gt;
...
pordwonS dna yttiK ,ecilA
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 3, in &lt;module&gt;
ZeroDivisionError: division by zero
&gt;&gt;&gt; what  # &lt;2&gt;
'YKCOWREBBAJ'
&gt;&gt;&gt; print('stdout is not restored!')  # &lt;3&gt;
!derotser ton si tuodts
</code></pre> <ul> <li> <code>&lt;1&gt;</code> : <code>ZeroDivisionError</code> is raised in the body of the block started by the <code>with</code> statement. The remaining code after the <code>yield</code> statement in the <code>looking_glass()</code> is not executed.</li> <li> <code>&lt;2&gt;</code>, <code>&lt;3&gt;</code> : Therefore, the original <code>sys.stdout.write</code> method is not restored and the output of <code>print()</code> is reversed.</li> </ul> <p>To handle this flaw on the original code of the <code>looking_glass()</code> function, the <code>try:</code>, <code>except:</code>, and <code>finally:</code> pattern on the <code>yield</code> statement can be used. The following code is an example of using the <code>try:</code>, <code>except:</code>, and <code>finally:</code> pattern on the <code>yield</code> statement.</p> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="6527037ae7319ba370a1ee2d9fe79214d0ed9452" path="18-with-match/mirror_gen_exc.py" language="python" line="78-97"></div> <ul> <li> <code>&lt;1&gt;</code> : The <code>msg</code> variable holds the exception message. By default, the <code>msg</code> variable is an empty <code>str</code> object.</li> <li> <code>&lt;2&gt;</code> : The <code>try:</code>, <code>except:</code>, and <code>finally:</code> pattern is used on the <code>yield</code> statement. In this pattern, <code>ZeroDivisionError</code> is caught and the exception message is assigned to the <code>msg</code> variable.</li> <li> <code>&lt;3&gt;</code>, <code>&lt;4&gt;</code> : The <code>finally:</code> block implements the <code>__exit__()</code> method parts of a context manager. In this block of code, the original <code>sys.stdout.write</code> method is restored and prints the exception message.</li> </ul> <pre><code class="language-python">&gt;&gt;&gt; with looking_glass() as what:
...      print('Alice, Kitty and Snowdrop')
...      print(f'{1/0}')  # &lt;1&gt;
...
pordwonS dna yttiK ,ecilA
Please DO NOT divide by zero!  # &lt;2&gt;
&gt;&gt;&gt; what  # &lt;3&gt;
'JABBERWOCKY'
&gt;&gt;&gt; print('back to normal')  # &lt;4&gt;
back to normal
&gt;&gt;&gt; with looking_glass() as what:
...      print('Alice, Kitty and Snowdrop')
...      print(f'{1 + [1, 2]}')
...
pordwonS dna yttiK ,ecilA
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 3, in &lt;module&gt;
TypeError: unsupported operand type(s) for +: 'int' and 'list'
&gt;&gt;&gt; print('back to normal again...')  # &lt;5&gt;
</code></pre> <ul> <li> <code>&lt;1&gt;</code> : <code>ZeroDivisionError</code> is raised in the body of the block started by the <code>with</code> statement.</li> <li> <code>&lt;2&gt;</code> : The exception message is printed.</li> <li> <code>&lt;3&gt;</code>, <code>&lt;4&gt;</code> : The original <code>sys.stdout.write</code> method is restored.</li> <li> <code>&lt;5&gt;</code> : The original <code>sts.stdout.write</code> method is restored. In case of <code>TypeError</code>, the exception is not caught by the <code>except ZeroDivisionError:</code>. Therefore, any error message is not printed.</li> </ul> <p>The decorated function can be used as a decorator. The following code is an example of using the decorated function as a decorator.</p> <pre><code class="language-python">&gt;&gt;&gt; @looking_glass()
... def prints():
...     print('Alice, Kitty and Snowdrop')
...     print(f'{1/0}')
...
&gt;&gt;&gt; prints()  # &lt;1&gt;
pordwonS dna yttiK ,ecilA
Please DO NOT divide by zero!
&gt;&gt;&gt; print('back to normal')
back to normal
</code></pre> <h3 id="real-world-example-of-a-contextmanager-decorator"><em>Real-world example of a contextmanager decorator</em></h3> <p>The following code is an example of using the <code>@contextlib.contextmanager</code> decorator which is described in this link <sup id="fnref:MartijnPieters_easyinplacefilerewriting" role="doc-noteref"><a href="#fn:MartijnPieters_easyinplacefilerewriting" class="footnote" rel="footnote">15</a></sup>.</p> <p>In this example, the following <code>inplace()</code> function is used to replace the content of a file with new content.</p> <pre><code class="language-python">import csv

with inplace(csvfilename, 'r', newline='') as (infh, outfh):
    reader = csv.reader(infh)
    writer = csv.writer(outfh)

    for row in reader:
        row += ['new', 'columns']
        writer.writerow(row)
</code></pre> <p>The implementation of the <code>inplace()</code> function is as follows:</p> <pre><code class="language-python">from contextlib import contextmanager
import io
import os


@contextmanager
def inplace(filename, mode='r', buffering=-1, encoding=None, errors=None,
            newline=None, backup_extension=None):
    """Allow for a file to be replaced with new content.

    yields a tuple of (readable, writable) file objects, where writable
    replaces readable.

    If an exception occurs, the old file is restored, removing the
    written data.

    mode should *not* use 'w', 'a' or '+'; only read-only-modes are supported.

    """

    # move existing file to backup, create new file with same permissions
    # borrowed extensively from the fileinput module
    if set(mode).intersection('wa+'):
        raise ValueError('Only read-only file modes can be used')

    backupfilename = filename + (backup_extension or os.extsep + 'bak')
    try:
        os.unlink(backupfilename)
    except os.error:
        pass
    os.rename(filename, backupfilename)
    readable = io.open(backupfilename, mode, buffering=buffering,
                       encoding=encoding, errors=errors, newline=newline)
    try:
        perm = os.fstat(readable.fileno()).st_mode
    except OSError:
        writable = open(filename, 'w' + mode.replace('r', ''),
                        buffering=buffering, encoding=encoding, errors=errors,
                        newline=newline)
    else:
        os_mode = os.O_CREAT | os.O_WRONLY | os.O_TRUNC
        if hasattr(os, 'O_BINARY'):
            os_mode |= os.O_BINARY
        fd = os.open(filename, os_mode, perm)
        writable = io.open(fd, "w" + mode.replace('r', ''), buffering=buffering,
                           encoding=encoding, errors=errors, newline=newline)
        try:
            if hasattr(os, 'chmod'):
                os.chmod(filename, perm)
        except OSError:
            pass
    try:
        yield readable, writable
    except Exception:
        # move backup back
        try:
            os.unlink(filename)
        except os.error:
            pass
        os.rename(backupfilename, filename)
        raise
    finally:
        readable.close()
        writable.close()
        try:
            os.unlink(backupfilename)
        except os.error:
            pass
</code></pre> <p>In this implementation, the <code>@contextlib.contextmanager</code> decorator is used to convert the <code>inplace()</code> function into a context manager. The <code>inplace()</code> function returns a context manager object.</p> <p>The file specified with the parameter <code>filename</code> is renamed to <code>filename + '.bak'</code> in the <code>backupfilename = ...</code> statement. The <code>backupfilename</code> is used to restore the original file when an exception is raised in the body of the block started by the <code>with</code> statement.</p> <p>The <code>yield</code> statement in the <code>inplace()</code> function returns a tuple of <code>(readable, writable)</code> file objects. The <code>readable</code> file object is a file object that is opened in the <code>inplace()</code> function. The <code>writable</code> file object is a file object that is opened in the <code>inplace()</code> function. The <code>writable</code> file object replaces the <code>readable</code> file object when the execution flow exits the <code>with</code> block.</p> <h3 id="implementation-of-contextmanager-decorator"><em>Implementation of contextmanager decorator</em></h3> <p>The following code is an implementation of the <code>@contextlib.contextmanager</code> decorator.</p> <div class="embed-github-src" repo="python/cpython/" branch="3.11" path="Lib/contextlib.py" language="python" line="272-302"></div> <p>The <code>@contextlib.contextmanager</code> decorator has one argument, <code>func</code>, which is a generator function. The <code>@contextlib.contextmanager</code> decorator returns an <code>helper()</code> function which is a closure function that returns <code>_GeneratorContextManager(func, args, kwds)</code> object. Note that the <code>@wraps(func)</code> decorator is used to copy the <code>__name__</code> and <code>__doc__</code> attributes of the <code>func</code> function to the <code>helper()</code> function.</p> <p>The <code>_GeneratorContextManager</code> class implements the context manager interface. In the implementation of the <code>_GeneratorContextManager</code> class, there is no implementation of <code>__init__()</code> method. Therefore, it is needed to investigate the parent class of the <code>_GeneratorContextManager</code> class to understand how the <code>_GeneratorContextManager</code> class is initialized.</p> <div class="embed-github-src" repo="python/cpython/" branch="3.11" path="Lib/contextlib.py" language="python" line="125-130"></div> <div class="embed-github-src" repo="python/cpython/" branch="3.11" path="Lib/contextlib.py" language="python" line="101-122"></div> <p>In the <code>_GeneratorContextManagerBase</code> class, there is an implementation of <code>__init__()</code> method. In this method, <code>self.gen</code> is initialized by <code>func(*args, **kwds)</code>. In addition, <code>self.func</code>, <code>self.args</code>, <code>self.kwds</code> and <code>self.__doc__</code> is initialized.</p> <p>The property <code>self.gen</code> is a generator object that is created by calling <code>func(*args, **kwds)</code>. This is used in the <code>__enter__()</code> method of the <code>_GeneratorContextManager</code> class. <code>self.args</code>, <code>self.kwds</code>, and <code>self.func</code> is deleted in the <code>del</code> statement.</p> <div class="embed-github-src" repo="python/cpython/" branch="3.11" path="Lib/contextlib.py" language="python" line="125-139"></div> <p>In the <code>__enter__()</code> method of the <code>_GeneratorContextManager</code> class, the decorated generator function is initialized by calling <code>next(self.gen)</code>. The <code>next(self.gen)</code> call executes the code before the <code>yield</code> statement in the decorated generator function. The yielded value is bound to the variable in the <code>with</code> statement.</p> <div class="embed-github-src" repo="python/cpython/" branch="3.11" path="Lib/contextlib.py" language="python" line="141-190"></div> <p>The execution flow is divided into two parts by the <code>typ</code> is None or not.</p> <p>If <code>typ</code> is <code>None</code>, any exception is not raised in the body of the block started by the <code>with</code> statement. In this case, the <code>__exit__()</code> method of the <code>_GeneratorContextManager</code> class is called with <code>None</code>, <code>None</code>, and <code>None</code> as arguments. The <code>__exit__()</code> method of the <code>_GeneratorContextManager</code> class calls <code>next(self.gen)</code> to execute the code after the <code>yield</code> statement in the decorated generator function.</p> <p>If <code>typ</code> is not <code>None</code>, an exception is raised in the body of the block started by the <code>with</code> statement. In this case, the <code>__exit__()</code> method of the <code>_GeneratorContextManager</code> class is called with <code>typ</code>, <code>val</code>, and <code>traceback</code> as arguments. The <code>__exit__()</code> method of the <code>_GeneratorContextManager</code> class calls <code>self.gen.throw(typ, val, traceback)</code> to raise the exception in the decorated generator function. The details of the <code>throw()</code> method of the generator object can be found in the this link<sup id="fnref:pythonorg__pep0342_throw" role="doc-noteref"><a href="#fn:pythonorg__pep0342_throw" class="footnote" rel="footnote">16</a></sup>.</p> <p>A generator function decorated with <code>@contextlib.contextmanager</code> can be used as a decorator. This functionality is implemented by the <code>ContextDecorator</code> class that is a parent class of the <code>_GeneratorContextManager</code> class.</p> <div class="embed-github-src" repo="python/cpython/" branch="3.11" path="Lib/contextlib.py" language="python" line="62-82"></div> <p>By the <code>__call__</code> method in the <code>ContextDecorator</code> class, the decorated generator function is called with <code>*args</code> and <code>**kwds</code> as arguments in the <code>with self._recreate_cm()</code> statement. The <code>self._recreate_cm()</code> method returns <code>self</code>, therefore the context manager described in the implementation of the <code>_GeneratorContextManager</code> class will be used.</p> <h2 id="pattern-matching-in-lispy-a-case-study">Pattern Matching in lis.py: A Case Study</h2> <p>In this section, real-world usage of <code>match</code>, <code>case</code> statement will be explained by the <code>lis.py</code> module which is a Lisp interpreter written by Peter Norvig <sup id="fnref:lispy" role="doc-noteref"><a href="#fn:lispy" class="footnote" rel="footnote">17</a></sup>.</p> <h3 id="scheme-syntax">Scheme Syntax</h3> <p>Scheme is a dialect of Lisp. The following code is an example of Scheme syntax.</p> <pre><code>(define (mod m n)
    (- m (* n (quotient m n))))

(define (gcd m n)
    (if (= n 0)
        m
        (gcd n (mod m n))))

(display (gcd 18 45))
</code></pre> <p>In the Scheme syntax, there is no distinction between statements and expressions. Also, there is no infix operator. All operators are prefix operators, for example, <code>(+ 1 2)</code> is an expression that is equivalant to <code>1+2</code> in Python. The parentheses are used to group expressions.</p> <p>The following Python code is equivalant to the Scheme code above.</p> <pre><code class="language-python">def mod(m, n):
    return m - (m // n * n)

def gcd(m, n):
    if n == 0:
        return m
    else:
        return gcd(n, mod(m, n))

print(gcd(18, 45))
</code></pre> <p>The details of the Scheme expressions can be found in the following links <sup id="fnref:scheme_expressions" role="doc-noteref"><a href="#fn:scheme_expressions" class="footnote" rel="footnote">18</a></sup> <sup id="fnref:lispy:1" role="doc-noteref"><a href="#fn:lispy" class="footnote" rel="footnote">17</a></sup>.</p> <p>The following subsections explain details of the <code>lis.py</code> module. In the Fluent Python book, minor revised version of the <code>lis.py</code> module is used.</p> <h3 id="imports-and-types">Imports and Types</h3> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="80f7f84274a47579e59c29a4657691525152c9d5" path="18-with-match/lispy/py3.10/lis.py" language="python" line="13-21"></div> <p>The type aliases <code>Symbol</code>, <code>Atom</code> and <code>Expression</code> are defined in the <code>lis.py</code> module.</p> <dl> <dt><code>Symbol</code></dt> <dd>A type alias of <code>str</code>. <code>Symbol</code> is used to represent identifiers in Scheme. In the sample code, assume that there is no string data type in Scheme for simplicity. Therefore, <code>Symbol</code> is used to represent only identifiers.</dd> <dt><code>Atom</code></dt> <dd>A type alias of <code>Union[int, float, Symbol]</code>. <code>Atom</code> is used to represent integers, floating point numbers and identifiers in Scheme.</dd> <dt><code>Expression</code></dt> <dd>A type alias of <code>Union[Atom, List]</code>. <code>Expression</code> is used to represent expressions in Scheme. <code>Expression</code> is a recursive data type.</dd> </dl> <h3 id="the-parser">The Parser</h3> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="80f7f84274a47579e59c29a4657691525152c9d5" path="18-with-match/lispy/py3.10/lis.py" language="python" line="27-59"></div> <p>The entry point of the parser of the Scheme syntax in <code>lis.py</code> is the <code>parse()</code> function.</p> <dl> <dt><code>def parse(program: str) -&gt; Expression:</code></dt> <dd>This function accepts a string that represents a Scheme program and returns an <code>Expression</code> object that represents the Scheme program.</dd> <dt><code>def tokenize(s: str) -&gt; list[str]:</code></dt> <dd>This function accepts a string that represents a Scheme program and returns a list of tokens. The tokens are separated by whitespace characters. By using this property, adding whitespace characters before and after each parenthesis and using <code>split()</code> on the string, the list of tokens can be obtained.</dd> <dt><code>def read_from_tokens(tokens: list[str]) -&gt; Expression:</code></dt> <dd>This function accepts a list of tokens and returns an <code>Expression</code> object that represents the Scheme program. This function is a recursive function. The <code>read_from_tokens()</code> function calls the <code>read_from_tokens()</code> function recursively to parse the nested expressions. <ol> <li>When an open parenthesis is found, the <code>read_from_tokens()</code> function generates an empty list for the nested expression.</li> <li>And then, the <code>read_from_tokens()</code> function calls the <code>read_from_tokens()</code> function recursively to parse the nested expression.</li> <li>When a close parenthesis is found, the <code>read_from_tokens()</code> function returns the list of tokens that represents the nested expression.</li> <li>When an atom is found, the <code>read_from_tokens()</code> function returns the atom by invoking the <code>parse_atom()</code> function.</li> </ol> </dd> <dt><code>def parse_atom(token: str) -&gt; Atom:</code></dt> <dd>This function accepts a token and returns an <code>Atom</code> object that represents the token. <ol> <li>If the token is an integer, the <code>int()</code> function is used to convert the token into an integer.</li> <li>If the token is a floating point number, the <code>float()</code> function is used to convert the token into a floating point number.</li> <li>Otherwise, the <code>Symbol()</code> function is used to convert the token into a <code>Symbol</code> object.</li> </ol> </dd> </dl> <p>The following code is an example of using the <code>parse()</code> function.</p> <pre><code class="language-python">&gt;&gt;&gt; from lis import parse
&gt;&gt;&gt; parse('1.5')
1.5
&gt;&gt;&gt; parse('(gcd 15 6)')
['gcd', 15, 6]
&gt;&gt;&gt; parse('''
... (define (gcd m n)
...     (if (= n 0)
...         m
...         (gcd n (mod m n))))
... ''')
['define', ['gcd', 'm', 'n'], ['if', ['=', 'n', 0], 'm', ['gcd', 'n', ['mod', 'm', 'n']]]]
</code></pre> <h3 id="the-environment">The Environment</h3> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="80f7f84274a47579e59c29a4657691525152c9d5" path="18-with-match/lispy/py3.10/lis.py" language="python" line="65-74"></div> <p>The <code>Environment</code> class is used to represent the environment of the Scheme interpreter. The <code>Environment</code> class extends the <code>collections.ChainMap</code> class <sup id="fnref:pythonorg__collections_chainmap" role="doc-noteref"><a href="#fn:pythonorg__collections_chainmap" class="footnote" rel="footnote">19</a></sup> by adding the <code>change()</code> method.</p> <p>The <code>change()</code> method of the <code>Environment</code> class is a method that is used to update existing keys. If the key is not found in the <code>Environment</code> object, the <code>change()</code> method raises a <code>KeyError</code> exception.</p> <p>The following code shows how to use the <code>Environment</code> class.</p> <pre><code class="language-python">&gt;&gt;&gt; from lis import Environment
&gt;&gt;&gt; env_first = {'a': 1, 'b': 2}
&gt;&gt;&gt; env_second = {'b': 3, 'c': 4}
&gt;&gt;&gt; env = Environment(env_first, env_second)
&gt;&gt;&gt; env['a']
1
&gt;&gt;&gt; env['b']  # &lt;1&gt;
2
&gt;&gt;&gt; env['c']
4
&gt;&gt;&gt; env['a'] = 10  # &lt;2&gt;
&gt;&gt;&gt; env['d'] = 5  # &lt;3&gt;
&gt;&gt;&gt; env
Environment({'a': 10, 'b': 2, 'd': 5}, {'b': 3, 'c': 4})
&gt;&gt;&gt; env.change('c', 40)  # &lt;4&gt;
&gt;&gt;&gt; env
Environment({'a': 10, 'b': 2, 'd': 5}, {'b': 3, 'c': 40})
&gt;&gt;&gt; env.change('b', 20)  # &lt;5&gt;
&gt;&gt;&gt; env
Environment({'a': 10, 'b': 20, 'd': 5}, {'b': 3, 'c': 40})
</code></pre> <ul> <li> <code>&lt;1&gt;</code> : The <code>b</code> key is found in the <code>env_first</code> object. Therefore, the value of the <code>b</code> key in the <code>env_first</code> object is returned.</li> <li> <code>&lt;2&gt;</code>, <code>&lt;3&gt;</code> : Assigning a value to the <code>Environment</code> object with <code>[]</code> always overwrites or add a key-value pair in the first mapping object, <code>env_first</code>.</li> <li> <code>&lt;4&gt;</code> : The <code>change()</code> method is used to update the value of the <code>c</code> key in-place in the <code>env_second</code> object.</li> <li> <code>&lt;5&gt;</code> : The <code>change()</code> method is used to update the value of the <code>b</code> key in-place in the <code>env_first</code> object.</li> </ul> <p>By using this <code>Environment</code> class, the <code>lis.py</code> module implements the <code>standard_env()</code> function which returns the global environment.</p> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="80f7f84274a47579e59c29a4657691525152c9d5" path="18-with-match/lispy/py3.10/lis.py" language="python" line="77-116"></div> <p>To sum up the above <code>standard_env()</code> function, the following functions and constants are defined in the global environment:</p> <ul> <li>All functions from the <code>math</code> module.</li> <li>Some functions from the <code>operator</code> module.</li> <li>Simple functions built with <code>lambda</code> expressions and built-in functions in Python.</li> </ul> <h3 id="the-repl">The REPL</h3> <p>REPL stands for read-eval-print-loop. The following code is the implementation of the REPL by the Norvig’s <code>lis.py</code> module.</p> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="80f7f84274a47579e59c29a4657691525152c9d5" path="18-with-match/lispy/py3.10/lis.py" language="python" line="122-136"></div> <dl> <dt><code>def repl(prompt: str = 'lis.py&gt; ') -&gt; NoReturn:</code></dt> <dd>The <code>repl()</code> function is an infinite loop that reads a Scheme program from the standard input, evaluates the Scheme program, and prints the result. <code>NoReturn</code> represents that the function does not return and loops forever. This function processes the following steps:</dd> </dl> <ol> <li>set <code>global_env</code> by using <code>Environment</code> class and <code>standard_env()</code>.</li> <li>jump into the infinite loop.</li> <li>get the input from the standard input by using the <code>input()</code> function.</li> <li>parse the input by using the <code>parse()</code> function.</li> <li>evaluate the parsed input by using the <code>evaluate()</code> with <code>global_env</code>.</li> <li>if the result is not <code>None</code>, print the result with <code>lispstr()</code> </li> </ol> <dl> <dt><code>def lispstr(exp: object) -&gt; str:</code></dt> <dd>Convert a python object into a string that is readable by the Scheme interpreter. For example, the <code>lispstr()</code> function converts <code>['+', 1, 2]</code> into <code>"(+ 1 2)"</code>.</dd> </dl> <h3 id="the-evaluator">The Evaluator</h3> <p>The evaluator in the <code>lis.py</code> uses the <code>match</code>, <code>case</code> statement to evaluate the Scheme program. The following code is the implementation of the evaluator in the <code>lis.py</code> module:</p> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="80f7f84274a47579e59c29a4657691525152c9d5" path="18-with-match/lispy/py3.10/lis.py" language="python" line="143-172"></div> <p>The <code>evaluate()</code> function consists of only one <code>match</code> statement. Details of the <code>case</code> statement in the <code>match</code> statement are as follows.</p> <h4 id="evaluating-numbers">Evaluating numbers</h4> <pre><code class="language-python">case int(x) | float(x):
    return x
</code></pre> <dl> <dt>Subject</dt> <dd>Instance of <code>int</code> or <code>float</code> class.</dd> <dt>Action</dt> <dd>Return value as is.</dd> <dt>Description</dt> <dd>This statement matches the <code>int</code> or <code>float</code> object. The <code>x</code> variable is bound to the matched whole <code>int</code> or <code>float</code> object rather than an attribute of the <code>int</code> or <code>float</code> object<sup id="fnref:pythonorg__compoundstatement_classpattern" role="doc-noteref"><a href="#fn:pythonorg__compoundstatement_classpattern" class="footnote" rel="footnote">20</a></sup>.</dd> <dt>Example</dt> <dd> </dd> </dl> <pre><code class="language-python">&gt;&gt;&gt; evaluate(1, {})
1
&gt;&gt;&gt; evaluate(1.5, {})
1.5
</code></pre> <h4 id="evaluating-symbols">Evaluating symbols</h4> <pre><code class="language-python">case Symbol(var):
    return env[var]
</code></pre> <dl> <dt>Subject</dt> <dd>Instance of <code>Symbol</code> class which means <code>str</code> object. (<code>Symbol: TypeAlias = str</code>)</dd> <dt>Action</dt> <dd>Return value of the result of lookup in the environment <code>env</code>.</dd> <dt>Description</dt> <dd>The <code>Symbol</code> class is a type alias of <code>str</code>. This statement matches the <code>str</code> object. The <code>var</code> variable is bound to the matched whole <code>str</code> object rather than an attribute of the <code>str</code> object <sup id="fnref:pythonorg__compoundstatement_classpattern:1" role="doc-noteref"><a href="#fn:pythonorg__compoundstatement_classpattern" class="footnote" rel="footnote">20</a></sup>.</dd> <dt>Example</dt> <dd> </dd> </dl> <pre><code class="language-python">&gt;&gt;&gt; evaluate('a', {'a': 1})
1
&gt;&gt;&gt; evaluate('+', standard_env())
&lt;built-in function add&gt;
</code></pre> <h4 id="quote-"><code>(quote ...)</code></h4> <pre><code class="language-python">case ['quote', x]:
    return x
</code></pre> <dl> <dt>Subject</dt> <dd>List object that has the <code>quote</code> as the first element and the length of the list is 2.</dd> <dt>Action</dt> <dd>Return the second element as is.</dd> <dt>Description</dt> <dd>This statement matches the list that has the <code>quote</code> as the first element, the <code>x</code> as the second element and the length of the list is 2.</dd> <dt>Example</dt> <dd> </dd> </dl> <pre><code class="language-python">&gt;&gt;&gt; evaluate(['quote', 1], {})
1
&gt;&gt;&gt; evaluate(['quote', ['+', 1, 2]], {})
['+', 1, 2]
&gt;&gt;&gt; evaluate(parse('(quote (+ 1 2))'), {})
['+', 1, 2]
</code></pre> <h4 id="if-"><code>(if ...)</code></h4> <pre><code class="language-python">case ["if", test, consequence, alternative]:
    if evaluate(test, env):
        return evaluate(consequence, env)
    else:
        return evaluate(alternative, env)
</code></pre> <dl> <dt>Subject</dt> <dd>List object that has the <code>if</code> as the first element and the length of the list is 4.</dd> <dt>Action</dt> <dd>Evaluate the <code>test</code> variable. If the result is <code>True</code>, evaluate the <code>consequence</code> variable. Otherwise, evaluate the <code>alternative</code> variable.</dd> <dt>Description</dt> <dd>This statement matches the list that has the <code>if</code> as the first element and the length of the list is 3. The <code>test</code>, <code>consequence</code>, and <code>alternative</code> variables are bound to the second, third, and fourth elements of the list respectively.</dd> </dl> <p>The <code>test</code> variable is evaluated by using the <code>evaluate()</code> function recursively. If the result of the <code>test</code> variable is <code>True</code>, the <code>consequence</code> variable is evaluated by using the <code>evaluate()</code> function recursively and the result is returned. Otherwise, the <code>alternative</code> variable is evaluated by using the <code>evaluate()</code> function recursively and the result is returned.</p> <dl> <dt>Example</dt> <dd> </dd> </dl> <pre><code class="language-python">&gt;&gt;&gt; evaluate(['if', 1, 2, 3], {})
2
&gt;&gt;&gt; evaluate(['if', 0, 2, 3], {})
3
&gt;&gt;&gt; evaluate(parse('(if 1 2 3)'), standard_env())
2
&gt;&gt;&gt; evaluate(parse('(if 0 2 3)'), standard_env())
3
</code></pre> <h4 id="lambda-"><code>(lambda ...)</code></h4> <pre><code class="language-python">case ['lambda', [*parms], *body] if body:
    return Procedure(parms, body, env)
</code></pre> <dl> <dt>Subject</dt> <dd>List object that satisfies the following conditions:</dd> </dl> <ol> <li>List object that has the <code>lambda</code> as the first element,</li> <li>List object that has a list object as the second element,</li> <li>and the length of the list is 3 or more.</li> </ol> <dl> <dt>Action</dt> <dd>Return a <code>Procedure</code> object that represents the lambda expression.</dd> <dt>Description</dt> <dd>This statement matches the list that has the <code>lambda</code> as the first element, a list object as the second element, and the length of the list is 3 or more. This statement catches the items in the list and bound to the <code>parms</code> and <code>body</code> variables.</dd> </dl> <ul> <li> <code>parms</code> : The <code>parms</code> variable is bound to the second element of the list. <ul> <li>The type of <code>parms</code> variable is <code>list</code>.</li> <li>The second element of the list can be an empty list or a list that has one or more elements.</li> </ul> </li> <li> <code>body</code> : The <code>body</code> variable is bound to the rest of the elements of the list. <ul> <li>The type of <code>body</code> variable is <code>list</code> which has one or more elements.</li> </ul> </li> </ul> <p>The <code>Procedure</code> class is used to represent the lambda expression. The details of <code>Procedure</code> will be discussed in the next section.</p> <dl> <dt>Example</dt> <dd> </dd> </dl> <pre><code class="language-python">&gt;&gt;&gt; evaluate(['lambda', ['a', 'b'], ['+', 'a', 'b']], standard_env())(1,2)
3
&gt;&gt;&gt; evaluate(['lambda', ['a', 'b'], '+', 'a', 'b'], standard_env())(1,2)
3
</code></pre> <pre><code class="language-python">&gt;&gt;&gt; expr = '(lambda (a b) (* (/ a b) 100))'
&gt;&gt;&gt; f = evaluate(parse(expr), standard_env())
&gt;&gt;&gt; f
&lt;lis.Procedure object at 0xffff89666120&gt;
&gt;&gt;&gt; f(15, 20)
75.0
</code></pre> <h4 id="define-"><code>(define ...)</code></h4> <pre><code class="language-python">case ['define', Symbol(name), value_exp]:
    env[name] = evaluate(value_exp, env)
</code></pre> <dl> <dt>Subject</dt> <dd>List object that has the <code>define</code> as the first element, <code>Symbol</code> object as the second element, and the length of the list is 3.</dd> <dt>Action</dt> <dd>Evaluate the third expression and bind the result to the second expression.</dd> <dt>Description</dt> <dd>This statement matches the list that has the <code>define</code> as the first element, <code>Symbol</code> object as the second element, and the length of the list is 3.</dd> </dl> <p>The <code>name</code> variable is bound to the second element of the list. The <code>value_exp</code> variable is evaluated by using the <code>evaluate()</code> function recursively and the result is bound to the <code>name</code> variable in the <code>env</code> environment.</p> <dl> <dt>Example</dt> <dd> </dd> </dl> <pre><code class="language-python">&gt;&gt;&gt; env = standard_env()
&gt;&gt;&gt; env['a']
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "/usr/local/lib/python3.12/collections/__init__.py", line 1014, in __getitem__
    return self.__missing__(key)            # support subclasses that define __missing__
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/collections/__init__.py", line 1006, in __missing__
    raise KeyError(key)
KeyError: 'a'
&gt;&gt;&gt; evaluate(['define', 'a', 1], env)
&gt;&gt;&gt; env['a']
1
&gt;&gt;&gt; evaluate(['define', 'b', ['+', 1, 2]], env)
&gt;&gt;&gt; env['b']
3
</code></pre> <h4 id="define--1"><code>(define ...)</code></h4> <pre><code class="language-python">case ['define', [Symbol(name), *parms], *body] if body:
    env[name] = Procedure(parms, body, env)
</code></pre> <dl> <dt>Subject</dt> <dd>List object that has the <code>define</code> as the first element, list object that has <code>Symbol</code> object as the first element and the length of the whole list is 3 or more.</dd> <dt>Action</dt> <dd>Bind the <code>Procedure</code> object to the <code>name</code> variable in the <code>env</code> environment.</dd> <dt>Description</dt> <dd>This statement matches the list that has the <code>define</code> as the first element, list object that has <code>Symbol</code> object as the first element and the length of the whole list is 3 or more.</dd> </dl> <p>The <code>name</code> variable is bound to the first element of the list. The <code>parms</code> variable is bound to the second element of the list. The <code>body</code> variable is bound to the rest of the elements of the list.</p> <p>The <code>Procedure</code> class is used to represent the lambda expression. The details of <code>Procedure</code> will be discussed in the next section.</p> <dl> <dt>Example</dt> <dd> </dd> </dl> <pre><code class="language-python">&gt;&gt;&gt; env = standard_env()
&gt;&gt;&gt; evaluate(parse('(define (add a b) (+ a b))'), env)
&gt;&gt;&gt; env['add']
&lt;lis.Procedure object at 0xffff89666120&gt;
&gt;&gt;&gt; env['add'](1, 2)
3
</code></pre> <h4 id="set-"><code>(set! ...)</code></h4> <pre><code class="language-python">case ['set!', Symbol(name), value_exp]:
    env.change(name, evaluate(value_exp, env))
</code></pre> <dl> <dt>Subject</dt> <dd>List object that has the <code>set!</code> as the first element, <code>Symbol</code> object as the second element, and the length of the list is 3.</dd> <dt>Action</dt> <dd>Evaluate the third expression and update the second expression.</dd> <dt>Description</dt> <dd>This statement matches the list that has the <code>set!</code> as the first element, <code>Symbol</code> object as the second element, and the length of the list is 3.</dd> <dt>Example</dt> <dd> </dd> </dl> <pre><code class="language-python">&gt;&gt;&gt; env = standard_env()
&gt;&gt;&gt; env['a'] = 1
&gt;&gt;&gt; evaluate(['set!', 'a', 2], env)
&gt;&gt;&gt; env['a']
2
</code></pre> <h4 id="function-call">Function call</h4> <pre><code class="language-python">KEYWORDS = ["quote", "if", "lambda", "define", "set!"]

case [func_exp, *args] if func_exp not in KEYWORDS:
    proc = evaluate(func_exp, env)
    values = [evaluate(arg, env) for arg in args]
    return proc(*values)
</code></pre> <dl> <dt>Subject</dt> <dd>List object that has the first element that is not in the <code>KEYWORDS</code> and the length of the list is 2 or more.</dd> <dt>Action</dt> <dd>Evaluate the first expression and the rest of the expressions and call the result of the first expression with the result of the rest of the expressions.</dd> <dt>Description</dt> <dd>This statement matches the list that has the first element that is not in the <code>KEYWORDS</code> and the length of the list is 2 or more.</dd> </dl> <p>The <code>func_exp</code> variable is evaluated by using the <code>evaluate()</code> function recursively and the result is bound to the <code>proc</code> variable. The <code>args</code> variable is also evaluated by using the <code>evaluate()</code> function recursively and the results are bound to the <code>values</code> variable.</p> <p>The <code>proc</code> variable is called with the <code>values</code> variable and the result is returned.</p> <dl> <dt>Example</dt> <dd> </dd> </dl> <pre><code class="language-python">&gt;&gt;&gt; env = standard_env()
&gt;&gt;&gt; evaluate(['+', 1, 2], env)
3
&gt;&gt;&gt; evaluate(['define', ['add', 'a', 'b'], ['+', 'a', 'b']], env)
&gt;&gt;&gt; evaluate(['add', 1, 2], env)
3
&gt;&gt;&gt; evaluate(['add', 1, ['+', 1, 2]], env)
4
</code></pre> <h4 id="default-case">Default case</h4> <pre><code class="language-python">case _:
    raise SyntaxError(lispstr(exp))
</code></pre> <p>This case statement is used to raise a <code>SyntaxError</code> exception when the <code>exp</code> variable does not match any of the patterns.</p> <h3 id="procedures-a-class-implementing-a-closure">Procedures: A Class Implementing a Closure</h3> <div class="embed-github-src" repo="fluentpython/example-code-2e/" branch="80f7f84274a47579e59c29a4657691525152c9d5" path="18-with-match/lispy/py3.10/lis.py" language="python" line="176-191"></div> <ul> <li> <code>&lt;1&gt;</code> : The constructor is called when <code>define</code> or <code>lambda</code> is evaluated.</li> <li> <code>&lt;2&gt;</code> : <code>self.parms</code> holds the names of the parameters, <code>self.body</code> holds the body of the function and <code>self.env</code> holds the environment in which the function was defined.</li> <li> <code>&lt;3&gt;</code> : The <code>Procedure</code> object can be called with the <code>args</code> variable.</li> <li> <code>&lt;4&gt;</code> : Build a new environment <code>local_env</code> that has the <code>self.parms</code> and <code>args</code> as the keys and values respectively.</li> <li> <code>&lt;5&gt;</code> : Build a combined environment by using <code>Environment</code> class. The <code>local_env</code> is the first mapping object and <code>self.env</code> is the second mapping object.</li> <li> <code>&lt;6&gt;</code> : Evaluate the <code>self.body</code> with the <code>env</code> environment.</li> <li> <code>&lt;7&gt;</code> : Return the result of the last expression in the <code>self.body</code>.</li> </ul> <h3 id="using-or-patterns">Using OR-patterns</h3> <p>Details of OR-patterns in the <code>case int(x) | float(x):</code> statement can be found in the following link<sup id="fnref:pythonorg__compoundstatement_orpatterns" role="doc-noteref"><a href="#fn:pythonorg__compoundstatement_orpatterns" class="footnote" rel="footnote">21</a></sup>.</p> <h2 id="do-this-then-that-else-blocks-beyond-if">Do This, Then That: else Blocks Beyond if</h2> <p>The <code>else</code> can be used with the <code>for</code>, <code>while</code> and <code>try</code> clause. The usage and meaning of the <code>else</code> clause with the <code>for</code>, <code>while</code> and <code>try</code> are different from <code>if/else</code> statement.</p> <p>The details of the <code>else</code> clause is as follows:</p> <h3 id="for"><code>for</code></h3> <p>The <code>else</code> clause in the <code>for</code> statement is executed when the loop is terminated normally. The <code>else</code> clause is not executed when the loop is terminated by a <code>break</code> statement.</p> <pre><code class="language-python">for item in items:
    if item == target:
        break
else:
    raise ValueError("Target not found")
</code></pre> <h3 id="while"><code>while</code></h3> <p>The <code>else</code> clause in the <code>while</code> statement is executed when the loop is terminated by a <code>False</code> condition. The <code>else</code> clause is not executed when the loop is terminated by a <code>break</code> statement.</p> <pre><code class="language-python">while condition:
    if item == target:
        break
else:
    raise ValueError("Target not found")
</code></pre> <h3 id="try"><code>try</code></h3> <p>The <code>else</code> clause in the <code>try</code> statement is executed when no exception is raised in the <code>try</code> block. The <code>else</code> clause is not executed when an exception is raised in the <code>try</code> block.</p> <p>Exception occurred in the <code>else</code> clause is not caught by the preceding <code>except</code> clause.</p> <pre><code class="language-python">try:
    do_something()
except ValueError:
    handle_value_error()
else:
    after_do_something()
</code></pre> <h3 id="eafp-and-lbyl"><em>EAFP and LBYL</em></h3> <p>The <code>else</code> clause in the <code>try</code> statement is used to implement the EAFP (Easier to Ask for Forgiveness than Permission) principle. The EAFP principle is a programming style that is used to catch exceptions rather than check conditions before the execution of the code.</p> <p>This principle makes the code more readable and maintainable because the normal path of the code is written first and the exceptional path of the code is written later.</p> <p>In contrast, the LBYL (Look Before You Leap) principle is a programming style that is used to check conditions before the execution of the code. This coding style explicitly checks the conditions before the execution of the code.</p> <p>Compared to the EAFP principle, the LBYL principle makes the code more unreadable because the normal path of the code is written later and the exceptional path of the code is written first.</p> <h2 id="chapter-summary">Chapter Summary</h2> <ul> <li>The <code>with</code> statement is used to manage resources by using the context managers. The context managers are used to set up and tear down resources automatically.</li> <li>The context manager interface is implemented by the <code>__enter__()</code> and <code>__exit__()</code> methods.</li> <li>The <code>contextlib</code> module provides the utilities for the context managers.</li> <li>The <code>contextlib.contextmanager</code> decorator is used to create a context manager by using a generator function.</li> <li>The <code>contextlib.ExitStack</code> class is used to manage multiple context managers at the same time.</li> <li>The <code>match</code>, <code>case</code> statement is used to implement the pattern matching in Python.</li> <li>The <code>lis.py</code> module is a Lisp interpreter written by Peter Norvig. The <code>lis.py</code> module uses the <code>match</code>, <code>case</code> statement to implement the pattern matching.</li> <li>The <code>else</code> clause can be used with the <code>for</code>, <code>while</code> and <code>try</code> statement. The <code>else</code> clause is executed when the loop is terminated normally or no exception is raised in the <code>try</code> block.</li> </ul> <h2 id="links">Links</h2> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:pythonorg__try_finally" role="doc-endnote"> <p><a href="https://docs.python.org/3/tutorial/errors.html#defining-clean-up-actions" rel="external nofollow noopener" target="_blank">8. Errors and Exceptions :: 8.7. Defining Clean-up Actions</a> <a href="#fnref:pythonorg__try_finally" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__sqlite3_context_manager" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/sqlite3.html#how-to-use-the-connection-context-manager" rel="external nofollow noopener" target="_blank"><code>sqlite3</code> — DB-API 2.0 interface for SQLite databases :: How to use the connection context manager</a> <a href="#fnref:pythonorg__sqlite3_context_manager" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__threading_example_with" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/threading.html#using-locks-conditions-and-semaphores-in-the-with-statement" rel="external nofollow noopener" target="_blank"><code>threading</code> — Thread-based parallelism :: Using locks, conditions, and semaphores in the with statement</a> <a href="#fnref:pythonorg__threading_example_with" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__decimal_example_with" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/decimal.html#decimal.localcontext" rel="external nofollow noopener" target="_blank">decimal — Decimal fixed point and floating point arithmetic :: <code>decimal.localcontext()</code></a> <a href="#fnref:pythonorg__decimal_example_with" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__unittestmock_example_with" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch" rel="external nofollow noopener" target="_blank">unittest.mock — mock object library :: <code>unittest.mock.patch()</code></a> <a href="#fnref:pythonorg__unittestmock_example_with" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__contextlib_parenthesized_context_managers" role="doc-endnote"> <p><a href="https://docs.python.org/3/whatsnew/3.10.html#parenthesized-context-managers" rel="external nofollow noopener" target="_blank">Parenthesized context managers</a> <a href="#fnref:pythonorg__contextlib_parenthesized_context_managers" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__contextlib" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/contextlib.html" rel="external nofollow noopener" target="_blank"><code>contextlib</code> — Utilities for <code>with</code>-statement contexts</a> <a href="#fnref:pythonorg__contextlib" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__contextlib_closing" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/contextlib.html#contextlib.closing" rel="external nofollow noopener" target="_blank"><code>contextlib</code> — Utilities for <code>with</code>-statement contexts :: <code>contextlib.closing(thing)</code></a> <a href="#fnref:pythonorg__contextlib_closing" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__contextlib_suppress" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/contextlib.html#contextlib.suppress" rel="external nofollow noopener" target="_blank"><code>contextlib</code> — Utilities for <code>with</code>-statement contexts :: <code>contextlib.suppress(*exceptions)</code></a> <a href="#fnref:pythonorg__contextlib_suppress" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__contextlib_nullcontext" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/contextlib.html#contextlib.nullcontext" rel="external nofollow noopener" target="_blank"><code>contextlib</code> — Utilities for <code>with</code>-statement contexts :: <code>contextlib.nullcontext(enter_result=None)</code></a> <a href="#fnref:pythonorg__contextlib_nullcontext" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__contextlib_contextmanager" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/contextlib.html#contextlib.contextmanager" rel="external nofollow noopener" target="_blank"><code>contextlib</code> — Utilities for <code>with</code>-statement contexts :: <code>@contextlib.contextmanager</code></a> <a href="#fnref:pythonorg__contextlib_contextmanager" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__contextlib_abstractcontextmanager" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/contextlib.html#contextlib.AbstractContextManager" rel="external nofollow noopener" target="_blank"><code>contextlib</code> — Utilities for <code>with</code>-statement contexts :: <code>class contextlib.AbstractContextManager</code></a> <a href="#fnref:pythonorg__contextlib_abstractcontextmanager" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__contextlib_contextdecorator" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/contextlib.html#contextlib.ContextDecorator" rel="external nofollow noopener" target="_blank"><code>contextlib</code> — Utilities for <code>with</code>-statement contexts :: <code>class contextlib.ContextDecorator</code></a> <a href="#fnref:pythonorg__contextlib_contextdecorator" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__contextlib_exitstack" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/contextlib.html#contextlib.ExitStack" rel="external nofollow noopener" target="_blank"><code>contextlib</code> — Utilities for <code>with</code>-statement contexts :: <code>class contextlib.ExitStack</code></a> <a href="#fnref:pythonorg__contextlib_exitstack" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:MartijnPieters_easyinplacefilerewriting" role="doc-endnote"> <p><a href="https://www.zopatista.com/python/2013/11/26/inplace-file-rewriting/" rel="external nofollow noopener" target="_blank">Easy in-place file rewriting</a> <a href="#fnref:MartijnPieters_easyinplacefilerewriting" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__pep0342_throw" role="doc-endnote"> <p><a href="https://peps.python.org/pep-0342/#new-generator-method-throw-type-value-none-traceback-none" rel="external nofollow noopener" target="_blank">New generator method: <code>throw(type, value=None, traceback=None)</code></a> <a href="#fnref:pythonorg__pep0342_throw" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:lispy" role="doc-endnote"> <p><a href="https://norvig.com/lispy.html" rel="external nofollow noopener" target="_blank">How to Write a (Lisp) Interpreter (in Python)</a> <a href="#fnref:lispy" class="reversefootnote" role="doc-backlink">↩</a> <a href="#fnref:lispy:1" class="reversefootnote" role="doc-backlink">↩<sup>2</sup></a></p> </li> <li id="fn:scheme_expressions" role="doc-endnote"> <p><a href="https://conservatory.scheme.org/schemers/Documents/Standards/R5RS/HTML/r5rs-Z-H-7.html" rel="external nofollow noopener" target="_blank">Revised Report on the Algorithmic Language Scheme :: Chapter 4. Expressions</a> <a href="#fnref:scheme_expressions" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__collections_chainmap" role="doc-endnote"> <p><a href="https://docs.python.org/3/library/collections.html#collections.ChainMap" rel="external nofollow noopener" target="_blank"><code>collections</code> — Container datatypes :: <code>class collections.ChainMap</code></a> <a href="#fnref:pythonorg__collections_chainmap" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:pythonorg__compoundstatement_classpattern" role="doc-endnote"> <p><a href="https://docs.python.org/3/reference/compound_stmts.html#class-patterns" rel="external nofollow noopener" target="_blank">8. Compound statements :: 8.6.4.10. Class Patterns</a> <a href="#fnref:pythonorg__compoundstatement_classpattern" class="reversefootnote" role="doc-backlink">↩</a> <a href="#fnref:pythonorg__compoundstatement_classpattern:1" class="reversefootnote" role="doc-backlink">↩<sup>2</sup></a></p> </li> <li id="fn:pythonorg__compoundstatement_orpatterns" role="doc-endnote"> <p><a href="https://docs.python.org/3/reference/compound_stmts.html#or-patterns" rel="external nofollow noopener" target="_blank">8. Compound statements :: 8.6.4.1. OR Patterns</a> <a href="#fnref:pythonorg__compoundstatement_orpatterns" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Dongseok Kim. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script> <script>hljs.highlightAll();</script> <script src="//cdn.jsdelivr.net/npm/highlightjs-line-numbers.js@2.8.0/dist/highlightjs-line-numbers.min.js"></script> <script>hljs.initLineNumbersOnLoad();</script> <script>function append_code_block_header(e){if(!e.className)return;const[t,r]=get_language_and_url(e);r&&(replace_className(e,t),elemCodeBlockHeader=create_elem_code_block_header(r),append_elem_code_block_header_to_previous(e,elemCodeBlockHeader))}function get_language_and_url(e){return e.className.split(/:(.*)/s)}function replace_className(e,t){e.classList.remove(e.className),e.classList.add(t)}function create_elem_code_block_header(e){var t=document.createElement("a");return t.textContent=e,(e.startsWith("http://")||e.startsWith("https://"))&&(t.setAttribute("href",e),t.setAttribute("target","_blank")),t.className="language-plaintext",t}function append_elem_code_block_header_to_previous(e,t){var r=e.parentElement;r.insertBefore(t,r.firstChild),r.classList.add("code-block-header")}function embed_external_source(e){var t=get_url_raw(e),r=get_url_blob(e),n=e.getAttribute("language"),c=get_lines(e),l=c[0],a=c[1];fetch(t).then(function(e){return e.text()}).then(function(t){var c=create_elem_code_block(n,r,t,l,a),o=create_elem_pre_from_code_block(c),_={startFrom:Math.max(l,1)};e.appendChild(o),hljs.highlightBlock(c),hljs.lineNumbersBlock(c,_)})["catch"](function(e){throw e})}function embed_local_source(e){var t=get_url_raw_local(e),r=get_url_blob_local(e),n=e.getAttribute("language"),c=get_lines(e),l=c[0],a=c[1];fetch(t).then(function(e){return e.text()}).then(function(t){var c=create_elem_code_block(n,r,t,l,a),o=create_elem_pre_from_code_block(c);e.appendChild(o),hljs.highlightBlock(c),hljs.lineNumbersBlock(c)})["catch"](function(e){throw e})}function get_url_raw(e){return["https://raw.githubusercontent.com",e.getAttribute("repo"),e.getAttribute("branch"),e.getAttribute("path")].join("/")}function get_url_blob(e){return["https://github.com",e.getAttribute("repo"),"blob",e.getAttribute("branch"),e.getAttribute("path")+get_line_specifier(e)].join("/")}function get_url_raw_local(e){return e.getAttribute("path")}function get_url_blob_local(e){return get_url_raw_local(e)}function get_lines(e){const t=e.getAttribute("line");if(!t)return[0,0];var[r,n]=t.split(/-(.*)/s);return r=parseInt(r),n=parseInt(n),isNaN(r)&&(r=0),isNaN(n)&&(n=0),[r,n]}function get_line_specifier(e){const t=get_lines(e);return 0==t[0]&&0==t[1]?"":(0==t[1]&&t[1],"#L"+String(t[0])+"-L"+String(t[1]))}function create_elem_code_block(e,t,r,n,c){var l=document.createElement("code");return l.className="language-"+e+":"+t,l.textContent=slice_by_line_number(r,n,c),l}function slice_by_line_number(e,t,r){return 0==t&&0==r?e:(0==t&&(t=1),e.split("\n").slice(t-1,r).join("\n"))}function create_elem_pre_from_code_block(e){var t=document.createElement("pre");return t.appendChild(e),append_code_block_header(e),t}const code=document.getElementsByTagName("code");Array.from(code).forEach(append_code_block_header);var divs=document.getElementsByClassName("embed-github-src");Array.prototype.forEach.call(divs,embed_external_source);divs=document.getElementsByClassName("embed-local-src");Array.prototype.forEach.call(divs,embed_local_source);</script> </body> </html>